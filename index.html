<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exam-Safe Python IDE</title>

  <link rel="manifest" href="manifest.json" />

  <style>
    :root {
      --bg:#1e1e1e;
      --panel:#2d2d2d;
      --accent:#007acc;
      --txt:#eaeaea;
      --out:#00ff99;
    }

    html, body {
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      overflow:hidden;
    }

    #topbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      background:var(--panel);
      padding:10px 12px;
    }

    .left {
      display:flex;
      align-items:center;
      gap:10px;
    }

    label {
      font-size:14px;
      opacity:.9;
    }

    input[type="text"] {
      background:#111;
      color:var(--txt);
      border:1px solid #444;
      border-radius:4px;
      padding:6px 8px;
    }

    button {
      background:var(--accent);
      color:#fff;
      border:none;
      padding:8px 14px;
      border-radius:4px;
      font-size:15px;
      cursor:pointer;
    }

    #container {
      display:grid;
      grid-template-columns:1fr 1fr;
      grid-template-rows:1fr 1fr;
      height:calc(100vh - 56px);
    }

    #editor {
      grid-column:1 / 2;
      grid-row:1 / 3;
      padding:12px;
      font-family:monospace;
      font-size:16px;
      background:#121212;
      color:#ddd;
      border:none;
      outline:none;
      resize:none;
    }

    #output {
      grid-column:2 / 3;
      grid-row:1 / 2;
      padding:12px;
      font-family:monospace;
      font-size:15px;
      background:#0c0c0c;
      color:var(--out);
      white-space:pre-wrap;
      overflow:auto;
    }

    #questionPane {
      grid-column:2 / 3;
      grid-row:2 / 3;
      background:#0d0d0d;
      border-top:1px solid #333;
      overflow:hidden;
    }

    #questionPane header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 10px;
      background:#111;
      font-size:14px;
    }

    #questionPane iframe {
      width:100%;
      height:calc(100% - 30px);
      border:none;
    }

    #status {
      font-size:12px;
      opacity:.8;
    }
  </style>
</head>

<body oncontextmenu="return false">

  <div id="topbar">
    <div class="left">
      <strong>Exam IDE</strong>
      <label>First name:
        <input type="text" id="firstName" autocomplete="off" spellcheck="false" />
      </label>
      <label>Last name:
        <input type="text" id="lastName" autocomplete="off" spellcheck="false" />
      </label>
    </div>

    <div class="right">
      <span id="status">
        Offline-ready:
        <span id="offlineFlag">checking…</span>
      </span>
      <button id="runBtn">Run ▶</button>
      <button id="submitBtn">Submit</button>
    </div>
  </div>

  <div id="container">
    <textarea id="editor"># Begin your exam code here
print("Start")</textarea>

    <pre id="output"></pre>

    <section id="questionPane">
      <header>
        <strong>Question (View-only)</strong>
        <span id="qStatus" style="font-size:12px;opacity:.75"></span>
      </header>
      <iframe id="questionFrame" referrerpolicy="no-referrer"></iframe>
    </section>
  </div>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

  <script>
    console.log("Initializing Exam IDE…");

    /* ================= CONFIG ================= */

    const SUBMIT_URL   = "PASTE_APPS_SCRIPT_WEB_APP_URL_HERE";
    const SUBMIT_TOKEN = "CHANGE_ME_SECRET";

    const QUESTION_MODE = "local"; // 'local' or 'drive'
    const QUESTION_DRIVE_URL = "PASTE_DRIVE_PREVIEW_URL_HERE";
    const QUESTION_LOCAL_PATH = "./questions/sample_question.pdf";

    /* ============== CLEAN START ============== */

    try {
      localStorage.clear();
      sessionStorage.clear();
    } catch {}

    /* ============ SERVICE WORKER ============== */

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("service-worker.js")
        .then(() => navigator.serviceWorker.ready)
        .then(() => {
          document.getElementById("offlineFlag").textContent = "ready";
        })
        .catch(() => {
          document.getElementById("offlineFlag").textContent = "unavailable";
        });
    } else {
      document.getElementById("offlineFlag").textContent = "unsupported";
    }

    /* ============= QUESTION VIEW ============== */

    const qFrame  = document.getElementById("questionFrame");
    const qStatus = document.getElementById("qStatus");

    qFrame.src =
      QUESTION_MODE === "local"
        ? QUESTION_LOCAL_PATH
        : QUESTION_DRIVE_URL;

    qFrame.addEventListener("load", () => {
      qStatus.textContent = "loaded";
    });

    /* ============== PYODIDE =================== */

    const pyReady = loadPyodide();

    pyReady
      .then(() => console.log("Pyodide ready"))
      .catch(err => console.error("Pyodide failed:", err));

    async function runCode() {
      const out = document.getElementById("output");
      const code = document.getElementById("editor").value;
      out.textContent = "Running…\n\n";

      try {
        const py = await pyReady;
        const result = await py.runPythonAsync(code);
        if (result !== undefined) out.textContent += result;
      } catch (err) {
        out.textContent += err;
      }
    }

    /* =============== SUBMIT =================== */

    async function submitCode() {
      const first = document.getElementById("firstName").value.trim();
      const last  = document.getElementById("lastName").value.trim();

      if (!first || !last) {
        alert("Enter first and last name before submitting.");
        return;
      }

      const payload = {
        token: SUBMIT_TOKEN,
        firstName: first,
        lastName: last,
        code: document.getElementById("editor").value,
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString()
      };

      try {
        const resp = await fetch(SUBMIT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) throw new Error(resp.status);
        alert("Submission sent.");
      } catch (e) {
        alert("Submission failed:\n" + e.message);
      }
    }

    document.getElementById("runBtn").addEventListener("click", runCode);
    document.getElementById("submitBtn").addEventListener("click", submitCode);
  </script>
</body>
</html>
